<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã</title>
    <link rel="stylesheet" href="/css/styleGroup.css">
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
</head>
<body>
    <main>
        <a href="/index.html"><button class="rasp" type="button">–û–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button></a>
        <div class="groupGrid" id="groups-container">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø...</div>
        </div>
    </main>

    <script>
        async function loadGroups() {
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∞—Ç
                const datesResponse = await fetch('/api/dates');
                const datesData = await datesResponse.json();
                
                // –ó–∞—Ç–µ–º –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
                const groupsResponse = await fetch('/api/groups');
                const groupsData = await groupsResponse.json();
                
                if (groupsData.success && datesData.success && datesData.dates.length > 0) {
                    // –ù–∞—Ö–æ–¥–∏–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –∏–ª–∏ –±–ª–∏–∂–∞–π—à—É—é –¥–∞—Ç—É
                    const todayDate = findTodayOrNextDate(datesData.dates);
                    renderGroups(groupsData.groups, todayDate);
                } else if (groupsData.success) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –≥—Ä—É–ø–ø—ã, –Ω–æ –Ω–µ—Ç –¥–∞—Ç
                    renderGroups(groupsData.groups);
                } else {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –∏–ª–∏ –±–ª–∏–∂–∞–π—à–µ–π –¥–∞—Ç—ã
        function findTodayOrNextDate(dates) {
            const today = new Date();
            const todayKey = parseInt(
                today.getFullYear().toString() + 
                (today.getMonth() + 1).toString().padStart(2, '0') + 
                today.getDate().toString().padStart(2, '0')
            );
            
            // –ò—â–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
            const todayDate = dates.find(date => date.sortKey === todayKey);
            if (todayDate) {
                console.log('üéØ –ù–∞–π–¥–µ–Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞:', todayDate.displayDate);
                return todayDate.urlDate;
            }
            
            // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É
            const nextDate = dates.find(date => date.sortKey >= todayKey);
            if (nextDate) {
                console.log('üîç –ù–∞–π–¥–µ–Ω–∞ –±–ª–∏–∂–∞–π—à–∞—è –¥–∞—Ç–∞:', nextDate.displayDate);
                return nextDate.urlDate;
            }
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –±–µ—Ä—ë–º –ø–µ—Ä–≤—É—é –¥–∞—Ç—É
            console.log('üìã –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é –¥–∞—Ç—É:', dates[0].displayDate);
            return dates[0].urlDate;
        }

        function renderGroups(groups, targetDate = '') {
            const container = document.getElementById('groups-container');
            if (!container) return;

            if (!groups || groups.length === 0) {
                container.innerHTML = '<div class="no-groups">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            container.innerHTML = '';

            // –í–ê–ñ–ù–û: groups —É–∂–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            // –ù–ï —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Ö, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
            groups.forEach(group => {
                const link = document.createElement('a');
                
                if (targetDate) {
                    link.href = `/mainGroup/${encodeURIComponent(group)}/${targetDate}`;
                } else {
                    link.href = `mainGroup.html?group=${encodeURIComponent(group)}`;
                }
                
                link.className = 'group-link';
                link.innerHTML = `<button type="button" class="group-btn">${group}</button>`;
                container.appendChild(link);
            });

            console.log(`‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –≥—Ä—É–ø–ø: ${groups.length} –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ`);
            console.log('üìã –ü–æ—Ä—è–¥–æ–∫ –≥—Ä—É–ø–ø:', groups);
        }

        function showError(message) {
            const container = document.getElementById('groups-container');
            if (container) {
                container.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', loadGroups);
    </script>

    <style>
        .loading, .no-groups, .error {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 1.1em;
            grid-column: 1 / -1;
        }

        .error {
            color: #e74c3c;
            background: #ffeaea;
            border-radius: 10px;
            margin: 20px;
        }
    </style>
</body>

</html>
